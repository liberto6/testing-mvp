<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>English Academy AI - Simple Mode</title>
    <style>
        body {
            font-family: sans-serif;
            background: #121212;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .card {
            background: #1e1e1e;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            width: 350px;
            border: 1px solid #333;
        }
        .indicator {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #333;
            margin: 20px auto;
            transition: 0.3s;
            border: 4px solid #121212;
        }
        .listening {
            background: #ff4b4b !important;
            box-shadow: 0 0 20px #ff4b4b;
        }
        .processing {
            background: #4b96ff !important;
            box-shadow: 0 0 20px #4b96ff;
            animation: pulse 1s infinite;
        }
        .speaking {
            background: #00e676 !important;
            box-shadow: 0 0 20px #00e676;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        button {
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            background: #00c853;
            color: white;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            color: #aaa;
            font-size: 0.9rem;
            min-height: 40px;
        }
        #debug {
            margin-top: 20px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #888;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }
    </style>
</head>
<body>

<div class="card">
    <h1>Sarah AI</h1>
    <div id="indicator" class="indicator"></div>
    <p id="status">Inicializando...</p>
    <button id="startBtn" disabled>ESPERANDO...</button>
    <button id="stopBtn" style="display:none; background:#ff4444;">PARAR</button>
    <div id="debug"></div>
</div>

<script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusText = document.getElementById('status');
    const indicator = document.getElementById('indicator');
    const debugDiv = document.getElementById('debug');

    let recognition = null;
    let ws = null;
    let isActive = false;

    // Debug logger
    function log(msg, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const color = type === 'error' ? '#ff4444' : type === 'success' ? '#00e676' : '#888';
        debugDiv.innerHTML += `<div style="color:${color}">[${timestamp}] ${msg}</div>`;
        debugDiv.scrollTop = debugDiv.scrollHeight;
        console.log(`[${timestamp}] ${msg}`);
    }

    // Audio queue
    const audioQueue = [];
    let isPlaying = false;
    let currentAudio = null;

    function stopAudio() {
        isPlaying = false;
        audioQueue.length = 0;

        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            currentAudio = null;
        }

        indicator.className = "indicator";
    }

    async function processQueue() {
        if (audioQueue.length === 0) {
            isPlaying = false;
            statusText.innerText = "Sarah te escucha.";
            indicator.className = "indicator";
            return;
        }

        isPlaying = true;
        const url = audioQueue.shift();
        currentAudio = new Audio(url);

        currentAudio.onended = () => {
            URL.revokeObjectURL(url);
            currentAudio = null;
            processQueue();
        };

        try {
            await currentAudio.play();
            statusText.innerText = "Sarah está hablando...";
            indicator.className = "indicator speaking";
        } catch (e) {
            log(`Error playing audio: ${e}`, 'error');
            processQueue();
        }
    }

    // WebSocket setup
    function setupWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        log(`Connecting to ${wsUrl}`);
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            log('WebSocket connected', 'success');
            statusText.innerText = "Conectado. Listo.";
            startBtn.disabled = false;
            startBtn.innerText = "EMPEZAR CLASE";
        };

        ws.onclose = (event) => {
            log(`WebSocket closed: ${event.code} ${event.reason}`, 'error');
            statusText.innerText = "Desconectado.";
            startBtn.disabled = true;
            isActive = false;
        };

        ws.onerror = (error) => {
            log(`WebSocket error: ${error}`, 'error');
        };

        ws.onmessage = (event) => {
            log(`Received audio chunk: ${event.data.size} bytes`);
            const blob = new Blob([event.data], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);

            audioQueue.push(url);

            if (!isPlaying) {
                processQueue();
            }
        };
    }

    // Speech Recognition setup
    function setupSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRecognition) {
            log('Web Speech API not supported!', 'error');
            statusText.innerText = "Web Speech API no soportado en este navegador.";
            return false;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            log('Speech recognition started');
            indicator.className = "indicator listening";
            statusText.innerText = "Escuchando...";
        };

        recognition.onend = () => {
            log('Speech recognition ended');
            if (isActive) {
                try {
                    recognition.start();
                } catch (e) {
                    log(`Error restarting recognition: ${e}`, 'error');
                }
            }
        };

        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            const confidence = event.results[0][0].confidence;

            log(`Detected: "${text}" (confidence: ${confidence.toFixed(2)})`, 'success');

            // Stop any playing audio
            stopAudio();

            // Send to server
            if (ws && ws.readyState === WebSocket.OPEN) {
                indicator.className = "indicator processing";
                statusText.innerText = "Procesando...";

                // Send as JSON with 'text' key
                ws.send(JSON.stringify({ text: text }));
                log(`Sent to server: "${text}"`);
            } else {
                log('WebSocket not ready, cannot send', 'error');
            }
        };

        recognition.onerror = (event) => {
            log(`Speech recognition error: ${event.error}`, 'error');

            if (event.error === 'no-speech') {
                log('No speech detected, will retry');
            } else if (event.error === 'not-allowed') {
                log('Microphone permission denied!', 'error');
                statusText.innerText = "Permisos de micrófono denegados.";
                isActive = false;
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }
        };

        return true;
    }

    // Start button handler
    startBtn.onclick = () => {
        if (!setupSpeechRecognition()) {
            return;
        }

        try {
            isActive = true;
            recognition.start();
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            log('System started', 'success');
        } catch (err) {
            log(`Error starting: ${err}`, 'error');
        }
    };

    // Stop button handler
    stopBtn.onclick = () => {
        isActive = false;
        if (recognition) {
            recognition.stop();
        }
        stopAudio();
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        statusText.innerText = "Detenido.";
        indicator.className = "indicator";
        log('System stopped');
    };

    // Initialize
    log('Initializing...');
    setupWebSocket();
</script>

</body>
</html>
